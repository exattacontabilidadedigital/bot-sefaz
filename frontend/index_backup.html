<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEFAZ Bot - Consulta Conta Corrente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .button-primary {
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .button-primary:hover:not(:disabled) {
            background-color: #1d4ed8;
        }
        
        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background-color: #f3f4f6;
            color: #111827;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .button-secondary:hover {
            background-color: #e5e7eb;
        }
        
        .input {
            display: block;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-color: #3b82f6;
        }
        
        .badge-success {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-warning {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-info {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
        }
        
        .progress-fill {
            background-color: #2563eb;
            height: 0.5rem;
            border-radius: 9999px;
            transition: all 0.3s;
        }
        
        .tab-button {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            color: #2563eb !important;
            border-color: #2563eb !important;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <i data-lucide="shield-check" class="h-8 w-8 text-blue-600 mr-3"></i>
                        <h1 class="text-3xl font-bold text-gray-900">SEFAZ Bot</h1>
                    </div>
                    <button id="refreshBtn" class="button-secondary flex items-center">
                        <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>
                        Atualizar
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button id="tab-consultas" class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        <i data-lucide="search" class="h-4 w-4 mr-2 inline"></i>
                        Consultas
                    </button>
                    <button id="tab-empresas" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i data-lucide="building" class="h-4 w-4 mr-2 inline"></i>
                        Empresas
                    </button>
                    <button id="tab-fila" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i data-lucide="clock" class="h-4 w-4 mr-2 inline"></i>
                        Fila de Processamento
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto pb-6 sm:px-6 lg:px-8">
            
            <!-- Tab Content: Consultas -->
            <div id="content-consultas" class="tab-content active mt-4">
            <!-- Dashboard Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="building" class="h-8 w-8 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total de Consultas</p>
                            <p id="totalConsultas" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="check-circle" class="h-8 w-8 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Empresas Ativas</p>
                            <p id="empresasAtivas" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="alert-triangle" class="h-8 w-8 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Com Dívidas</p>
                            <p id="empresasComDividas" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="dollar-sign" class="h-8 w-8 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Dívidas</p>
                            <p id="valorTotalDividas" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="card p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Nova Consulta</h2>
                
                <!-- Status da Consulta -->
                <div id="statusSection" class="mb-6 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Status da Consulta</span>
                        <span id="statusText" class="text-sm text-gray-500">Aguardando...</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="currentStep" class="text-xs text-gray-500 mt-1">Aguardando início...</p>
                </div>

                <!-- Formulário -->
                <form id="consultaForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="usuario" class="block text-sm font-medium text-gray-700 mb-1">
                                Usuário (CPF)
                            </label>
                            <input 
                                type="text" 
                                id="usuario" 
                                name="usuario" 
                                placeholder="Deixe vazio para usar .env"
                                class="input"
                            >
                        </div>
                        <div>
                            <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">
                                Senha
                            </label>
                            <input 
                                type="password" 
                                id="senha" 
                                name="senha" 
                                placeholder="Deixe vazio para usar .env"
                                class="input"
                            >
                        </div>
                        <div>
                            <label for="inscricaoEstadual" class="block text-sm font-medium text-gray-700 mb-1">
                                Inscrição Estadual (opcional)
                            </label>
                            <input 
                                type="text" 
                                id="inscricaoEstadual" 
                                name="inscricaoEstadual" 
                                placeholder="Quando há múltiplas IEs"
                                class="input"
                            >
                            <p class="text-xs text-gray-500 mt-1">Use quando um CPF possui várias inscrições</p>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="button-primary flex items-center"
                        >
                            <i data-lucide="play" class="h-4 w-4 mr-2"></i>
                            Executar Consulta
                        </button>
                    </div>
                </form>
            </div>

            <!-- Resultados -->
            <div class="card">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Consultas Realizadas</h2>
                        <div class="flex items-center space-x-2">
                            <span id="totalResults" class="text-sm text-gray-500">0 resultados</span>
                            <button id="clearFiltersBtn" class="button-secondary text-sm hidden">
                                <i data-lucide="x" class="h-4 w-4 mr-1"></i>
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <input 
                                type="text" 
                                id="searchFilter" 
                                placeholder="Buscar por empresa ou IE..."
                                class="input"
                            >
                        </div>
                        <div>
                            <select id="statusFilter" class="input">
                                <option value="">Todos os Status</option>
                                <option value="ATIVO">Ativo</option>
                                <option value="INATIVO">Inativo</option>
                                <option value="SUSPENSO">Suspenso</option>
                            </select>
                        </div>
                        <div>
                            <select id="tviFilter" class="input">
                                <option value="">TVIs - Todos</option>
                                <option value="SIM">Com TVIs</option>
                                <option value="NÃO">Sem TVIs</option>
                            </select>
                        </div>
                        <div>
                            <select id="dividaFilter" class="input">
                                <option value="">Dívidas - Todos</option>
                                <option value="SIM">Com Dívidas</option>
                                <option value="NÃO">Sem Dívidas</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Empresa
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    IE
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    TVIs
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Dívidas
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Data
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody id="resultTable" class="bg-white divide-y divide-gray-200">
                            <!-- Dados serão inseridos aqui -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginação -->
                <div id="paginationContainer" class="px-6 py-4 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Mostrando <span id="showingFrom">1</span> a <span id="showingTo">10</span> de <span id="showingTotal">0</span> resultados
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="prevPageBtn" class="button-secondary disabled:opacity-50" disabled>
                                <i data-lucide="chevron-left" class="h-4 w-4"></i>
                                Anterior
                            </button>
                            <span id="pageInfo" class="text-sm text-gray-700">Página 1 de 1</span>
                            <button id="nextPageBtn" class="button-secondary disabled:opacity-50" disabled>
                                Próxima
                                <i data-lucide="chevron-right" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="emptyState" class="text-center py-12 hidden">
                    <i data-lucide="search" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma consulta encontrada</h3>
                    <p class="text-gray-500">Execute uma consulta para ver os resultados aqui.</p>
                </div>
            </div>
        </main>
        
        <!-- Modal de Detalhes -->
        <div id="detailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Detalhes da Consulta</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                    <div id="modalContent" class="space-y-3">
                        <!-- Conteúdo será inserido aqui -->
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeModal()" class="button-secondary">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

            </div>
            <!-- End Tab Content: Consultas -->
            
            <!-- Tab Content: Empresas -->
            <div id="content-empresas" class="tab-content mt-4">
                    <!-- Header da seção -->
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Gerenciamento de Empresas</h2>
                        <button id="addEmpresaBtn" class="button-primary flex items-center">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Nova Empresa
                        </button>
                    </div>
                    
                    <!-- Filtros para empresas -->
                    <div class="card p-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="form-label">Buscar</label>
                                <input id="empresaSearchFilter" type="text" class="form-input" placeholder="Nome, CNPJ ou IE...">
                            </div>
                            <div>
                                <label class="form-label">Status</label>
                                <select id="empresaAtivoFilter" class="form-input">
                                    <option value="">Todos</option>
                                    <option value="1">Ativo</option>
                                    <option value="0">Inativo</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="clearEmpresaFiltersBtn" class="button-secondary hidden">
                                    <i data-lucide="x" class="h-4 w-4 mr-2"></i>
                                    Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de empresas -->
                    <div class="card">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium">Lista de Empresas</h3>
                                <span id="totalEmpresasResults" class="text-sm text-gray-500">0 empresas</span>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="selectAllEmpresas" class="rounded">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CNPJ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IE</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado em</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="empresasTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Dados das empresas serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Estado vazio para empresas -->
                        <div id="empresasEmptyState" class="hidden text-center py-12">
                            <i data-lucide="building" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhuma empresa encontrada</h3>
                            <p class="mt-1 text-sm text-gray-500">Comece criando uma nova empresa.</p>
                        </div>
                        
                        <!-- Paginação para empresas -->
                        <div class="bg-gray-50 px-6 py-3 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-700">
                                    Mostrando <span id="empresasShowingFrom">0</span> a <span id="empresasShowingTo">0</span> de <span id="empresasShowingTotal">0</span> empresas
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="empresasPageInfo" class="text-sm text-gray-700">Página 1 de 1</span>
                                    <button id="empresasPrevPageBtn" class="button-secondary" disabled>
                                        <i data-lucide="chevron-left" class="h-4 w-4"></i>
                                    </button>
                                    <button id="empresasNextPageBtn" class="button-secondary" disabled>
                                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ações em lote -->
                    <div id="empresasActions" class="card p-4 hidden">
                        <div class="flex items-center justify-between">
                            <span id="selectedEmpresasCount" class="text-sm text-gray-600">0 empresas selecionadas</span>
                            <div class="flex space-x-2">
                                <button id="executeSelectedBtn" class="button-primary">
                                    <i data-lucide="play" class="h-4 w-4 mr-2"></i>
                                    Executar Consultas
                                </button>
                                <button id="deactivateSelectedBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded">
                                    <i data-lucide="pause" class="h-4 w-4 mr-2"></i>
                                    Desativar
                                </button>
                            </div>
                        </div>
                    </div>
            </div>
            <!-- End Tab Content: Empresas -->
            
            <!-- Tab Content: Fila -->
            <div id="content-fila" class="tab-content mt-4">
                    <h2 class="text-2xl font-bold text-gray-900">Fila de Processamento</h2>
                    <!-- Dashboard da Fila -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="card p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="filaTotal">-</div>
                                <div class="text-sm text-gray-500">Total</div>
                            </div>
                        </div>
                        <div class="card p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="filaPending">-</div>
                                <div class="text-sm text-gray-500">Pendente</div>
                            </div>
                        </div>
                        <div class="card p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="filaRunning">-</div>
                                <div class="text-sm text-gray-500">Executando</div>
                            </div>
                        </div>
                        <div class="card p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="filaCompleted">-</div>
                                <div class="text-sm text-gray-500">Concluído</div>
                            </div>
                        </div>
                        <div class="card p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="filaFailed">-</div>
                                <div class="text-sm text-gray-500">Falhou</div>
                            </div>
                        </div>
                    </div>

                    <!-- Controles da Fila -->
                    <div class="card p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium">Controles da Fila</h3>
                            <div class="flex space-x-2">
                                <button id="refreshFilaBtn" class="button-secondary">
                                    <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>
                                    Atualizar
                                </button>
                                <button id="clearCompletedBtn" class="button-secondary">
                                    <i data-lucide="trash-2" class="h-4 w-4 mr-2"></i>
                                    Limpar Concluídos
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Jobs -->
                    <div class="card">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium">Jobs na Fila</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conclusão</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tentativas</th>
                                    </tr>
                                </thead>
                                <tbody id="filaJobsTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Jobs serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Estado vazio -->
                        <div id="filaEmptyState" class="text-center py-12 hidden">
                            <i data-lucide="clock" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum job na fila</h3>
                            <p class="mt-1 text-sm text-gray-500">Adicione empresas à fila para começar o processamento.</p>
                        </div>
                    </div>
            </div>
            <!-- End Tab Content: Fila -->
            
        </main>
    </div>

    <!-- Modal para cadastro/edição de empresa -->
    <div id="empresaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="empresaModalTitle" class="text-lg font-medium text-gray-900">Nova Empresa</h3>
                    <button onclick="closeEmpresaModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                
                <form id="empresaForm" class="space-y-4">
                    <input type="hidden" id="empresaId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Nome da Empresa *</label>
                            <input id="empresaNome" type="text" class="form-input" required>
                        </div>
                        <div>
                            <label class="form-label">CNPJ *</label>
                            <input id="empresaCnpj" type="text" class="form-input" placeholder="XX.XXX.XXX/XXXX-XX" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Inscrição Estadual *</label>
                            <input id="empresaIE" type="text" class="form-input" required>
                        </div>
                        <div>
                            <label class="form-label">CPF do Sócio *</label>
                            <input id="empresaCpf" type="text" class="form-input" placeholder="XXX.XXX.XXX-XX" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">Senha *</label>
                        <input id="empresaSenha" type="password" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="form-label">Observações</label>
                        <textarea id="empresaObservacoes" class="form-input" rows="3" placeholder="Observações opcionais"></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input id="empresaAtivo" type="checkbox" class="rounded" checked>
                        <label for="empresaAtivo" class="ml-2 text-sm text-gray-700">Empresa ativa</label>
                    </div>
                    
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="closeEmpresaModal()" class="button-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="button-primary">
                            <i data-lucide="save" class="h-4 w-4 mr-2"></i>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicação
        let isPolling = false;
        let pollInterval = null;
        let consultasData = []; // Armazenar dados das consultas para o modal
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalItems = 0;
        let currentFilters = {
            search: '',
            status: '',
            tem_tvi: '',
            tem_divida: ''
        };
        
        // Estado para empresas
        let empresasData = [];
        let currentEmpresasPage = 1;
        let empresasItemsPerPage = 10;
        let totalEmpresasItems = 0;
        let currentEmpresasFilters = {
            search: '',
            ativo: ''
        };
        let selectedEmpresas = new Set();
        
        // Estado para abas
        let currentTab = 'consultas';

        // Inicializar Lucide icons
        try {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        } catch (error) {
            console.warn('Erro ao inicializar ícones Lucide:', error);
        }
        
        // ================================
        // GERENCIAMENTO DE ABAS
        // ================================
        
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName); // Debug
            
            // Atualizar estado
            currentTab = tabName;
            
            // Atualizar botões das abas
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('border-transparent', 'text-gray-500');
                btn.classList.remove('border-blue-500', 'text-blue-600');
            });
            
            const activeTab = document.getElementById(`tab-${tabName}`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.classList.remove('border-transparent', 'text-gray-500');
                activeTab.classList.add('border-blue-500', 'text-blue-600');
            }
            
            // Atualizar conteúdo
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const activeContent = document.getElementById(`content-${tabName}`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
            
            // Carregar dados específicos da aba
            if (tabName === 'empresas') {
                fetchEmpresas();
            } else if (tabName === 'consultas') {
                fetchConsultas();
                fetchEstatatisticas();
            } else if (tabName === 'fila') {
                fetchFilaJobs();
                console.log('Carregando dados da fila');
            }
            
            // Recriar ícones
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao criar ícones:', error);
            }
        }
        
        // ================================
        // FUNÇÕES PARA EMPRESAS
        // ================================
        
        async function fetchEmpresas() {
            try {
                // Construir parâmetros da query
                const params = new URLSearchParams({
                    limit: empresasItemsPerPage.toString(),
                    offset: ((currentEmpresasPage - 1) * empresasItemsPerPage).toString()
                });
                
                // Adicionar filtros se existirem
                if (currentEmpresasFilters.search) params.append('search', currentEmpresasFilters.search);
                if (currentEmpresasFilters.ativo !== '') params.append('ativo', currentEmpresasFilters.ativo);
                
                const response = await fetch(`/api/empresas?${params}`);
                const empresas = await response.json();
                empresasData = empresas;
                
                // Buscar total de itens
                const countParams = new URLSearchParams();
                if (currentEmpresasFilters.search) countParams.append('search', currentEmpresasFilters.search);
                if (currentEmpresasFilters.ativo !== '') countParams.append('ativo', currentEmpresasFilters.ativo);
                
                const countResponse = await fetch(`/api/empresas/count?${countParams}`);
                const countData = await countResponse.json();
                totalEmpresasItems = countData.total;
                
                updateEmpresasTable(empresas);
                updateEmpresasPagination();
                
            } catch (error) {
                console.error('Erro ao buscar empresas:', error);
                showNotification('Erro ao carregar empresas', 'error');
            }
        }
        
        function updateEmpresasTable(empresas) {
            console.log('Atualizando tabela de empresas com:', empresas); // Debug
            
            const tbody = document.getElementById('empresasTable');
            const emptyState = document.getElementById('empresasEmptyState');
            const totalResults = document.getElementById('totalEmpresasResults');
            
            if (totalResults) {
                totalResults.textContent = `${totalEmpresasItems} empresa${totalEmpresasItems !== 1 ? 's' : ''}`;
            }
            
            if (!empresas || empresas.length === 0) {
                if (tbody) tbody.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }
            
            if (emptyState) emptyState.classList.add('hidden');
            
            if (tbody) {
                tbody.innerHTML = empresas.map(empresa => `
                    <tr class="hover:bg-gray-50" data-cpf-socio="${empresa.cpf_socio || ''}" data-senha="${empresa.senha || ''}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="empresa-checkbox rounded" value="${empresa.id}" ${selectedEmpresas.has(empresa.id) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${empresa.nome_empresa || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatCNPJ(empresa.cnpj || '')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${empresa.inscricao_estadual || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${empresa.ativo ? 
                                '<span class="badge-success">Ativo</span>' : 
                                '<span class="badge-danger">Inativo</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">
                                ${new Date(empresa.data_criacao).toLocaleDateString('pt-BR')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button onclick="editEmpresa(${empresa.id})" class="text-blue-600 hover:text-blue-900 p-1" title="Editar">
                                    <i data-lucide="edit-2" class="h-4 w-4"></i>
                                </button>
                                <button onclick="deleteEmpresa(${empresa.id})" class="text-red-600 hover:text-red-900 p-1" title="Excluir">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                console.log('Tabela atualizada com', empresas.length, 'empresas'); // Debug
            }
            
            // Atualizar seleção
            updateSelectedEmpresas();
            
            // Re-inicializar ícones
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao criar ícones:', error);
            }
        }
        
        function updateEmpresasPagination() {
            const totalPages = Math.ceil(totalEmpresasItems / empresasItemsPerPage);
            const showingFrom = totalEmpresasItems === 0 ? 0 : ((currentEmpresasPage - 1) * empresasItemsPerPage) + 1;
            const showingTo = Math.min(currentEmpresasPage * empresasItemsPerPage, totalEmpresasItems);
            
            const showingFromEl = document.getElementById('empresasShowingFrom');
            const showingToEl = document.getElementById('empresasShowingTo');
            const showingTotalEl = document.getElementById('empresasShowingTotal');
            const pageInfoEl = document.getElementById('empresasPageInfo');
            const prevPageBtn = document.getElementById('empresasPrevPageBtn');
            const nextPageBtn = document.getElementById('empresasNextPageBtn');
            
            if (showingFromEl) showingFromEl.textContent = showingFrom;
            if (showingToEl) showingToEl.textContent = showingTo;
            if (showingTotalEl) showingTotalEl.textContent = totalEmpresasItems;
            if (pageInfoEl) pageInfoEl.textContent = `Página ${currentEmpresasPage} de ${totalPages}`;
            
            if (prevPageBtn) prevPageBtn.disabled = currentEmpresasPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentEmpresasPage === totalPages || totalPages === 0;
        }
        
        function formatCNPJ(cnpj) {
            if (!cnpj) return '';
            // Remove caracteres não numéricos
            const numbers = cnpj.replace(/\D/g, '');
            // Aplica máscara XX.XXX.XXX/XXXX-XX se tiver 14 dígitos
            if (numbers.length === 14) {
                return numbers.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            }
            return cnpj; // Retorna original se não tiver 14 dígitos
        }
        
        function applyEmpresasFilters() {
            const searchEl = document.getElementById('empresaSearchFilter');
            const ativoEl = document.getElementById('empresaAtivoFilter');
            const clearBtnEl = document.getElementById('clearEmpresaFiltersBtn');
            
            currentEmpresasFilters = {
                search: searchEl ? searchEl.value.trim() : '',
                ativo: ativoEl ? ativoEl.value : ''
            };
            
            currentEmpresasPage = 1; // Resetar para primeira página
            fetchEmpresas();
            
            // Mostrar/esconder botão de limpar filtros
            const hasFilters = Object.values(currentEmpresasFilters).some(value => value !== '');
            if (clearBtnEl) {
                clearBtnEl.classList.toggle('hidden', !hasFilters);
            }
        }
        
        function openEmpresaModal(empresaId = null) {
            console.log('Abrindo modal para empresa ID:', empresaId); // Debug
            
            const modal = document.getElementById('empresaModal');
            const title = document.getElementById('empresaModalTitle');
            const form = document.getElementById('empresaForm');
            
            if (!modal || !title || !form) {
                console.error('Elementos do modal não encontrados');
                return;
            }
            
            // Limpar formulário
            form.reset();
            const empresaIdField = document.getElementById('empresaId');
            const empresaAtivoField = document.getElementById('empresaAtivo');
            const empresaSenhaField = document.getElementById('empresaSenha');
            
            if (empresaIdField) empresaIdField.value = '';
            if (empresaAtivoField) empresaAtivoField.checked = true;
            
            if (empresaId) {
                // Modo edição
                title.textContent = 'Editar Empresa';
                const empresa = empresasData.find(e => e.id === empresaId);
                console.log('Empresa encontrada para edição:', empresa); // Debug
                
                if (empresa) {
                    if (empresaIdField) empresaIdField.value = empresa.id;
                    
                    const nomeField = document.getElementById('empresaNome');
                    const cnpjField = document.getElementById('empresaCnpj');
                    const ieField = document.getElementById('empresaIE');
                    const cpfField = document.getElementById('empresaCpf');
                    const obsField = document.getElementById('empresaObservacoes');
                    
                    if (nomeField) nomeField.value = empresa.nome_empresa || '';
                    if (cnpjField) cnpjField.value = empresa.cnpj || '';
                    if (ieField) ieField.value = empresa.inscricao_estadual || '';
                    if (cpfField) cpfField.value = empresa.cpf_socio || '';
                    if (obsField) obsField.value = empresa.observacoes || '';
                    if (empresaAtivoField) empresaAtivoField.checked = empresa.ativo;
                    
                    // Não preencher senha para edição
                    if (empresaSenhaField) {
                        empresaSenhaField.placeholder = 'Deixe em branco para manter a atual';
                        empresaSenhaField.required = false;
                    }
                }
            } else {
                // Modo criação
                title.textContent = 'Nova Empresa';
                if (empresaSenhaField) {
                    empresaSenhaField.placeholder = '';
                    empresaSenhaField.required = true;
                }
            }
            
            modal.classList.remove('hidden');
            
            // Focar no primeiro campo
            const nomeField = document.getElementById('empresaNome');
            if (nomeField) {
                setTimeout(() => nomeField.focus(), 100);
            }
        }
        
        function closeEmpresaModal() {
            const modal = document.getElementById('empresaModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function editEmpresa(empresaId) {
            openEmpresaModal(empresaId);
        }
        
        async function deleteEmpresa(empresaId) {
            if (!confirm('Tem certeza que deseja excluir esta empresa?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/empresas/${empresaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await fetchEmpresas();
                    showNotification('Empresa excluída com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Erro ao excluir: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir empresa:', error);
                showNotification('Erro ao excluir empresa', 'error');
            }
        }
        
        function updateSelectedEmpresas() {
            const checkboxes = document.querySelectorAll('.empresa-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllEmpresas');
            const actionsDiv = document.getElementById('empresasActions');
            const countSpan = document.getElementById('selectedEmpresasCount');
            
            // Atualizar seleção individual
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedEmpresas.add(parseInt(this.value));
                    } else {
                        selectedEmpresas.delete(parseInt(this.value));
                    }
                    updateSelectedEmpresasUI();
                });
            });
            
            // Atualizar "selecionar todos"
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            selectedEmpresas.add(parseInt(checkbox.value));
                        } else {
                            selectedEmpresas.delete(parseInt(checkbox.value));
                        }
                    });
                    updateSelectedEmpresasUI();
                });
            }
            
            updateSelectedEmpresasUI();
        }
        
        function updateSelectedEmpresasUI() {
            const actionsDiv = document.getElementById('empresasActions');
            const countSpan = document.getElementById('selectedEmpresasCount');
            
            if (countSpan) {
                countSpan.textContent = `${selectedEmpresas.size} empresa${selectedEmpresas.size !== 1 ? 's' : ''} selecionada${selectedEmpresas.size !== 1 ? 's' : ''}`;
            }
            
            if (actionsDiv) {
                if (selectedEmpresas.size > 0) {
                    actionsDiv.classList.remove('hidden');
                } else {
                    actionsDiv.classList.add('hidden');
                }
            }
        }

        // API Functions
        async function fetchEstatatisticas() {
            try {
                const response = await fetch('/api/estatisticas');
                const data = await response.json();
                
                document.getElementById('totalConsultas').textContent = data.total_consultas;
                document.getElementById('empresasAtivas').textContent = data.empresas_ativas;
                document.getElementById('empresasComDividas').textContent = data.empresas_com_dividas;
                document.getElementById('valorTotalDividas').textContent = 
                    new Intl.NumberFormat('pt-BR', { 
                        style: 'currency', 
                        currency: 'BRL' 
                    }).format(data.valor_total_dividas);
            } catch (error) {
                console.error('Erro ao buscar estatísticas:', error);
            }
        }

        async function fetchConsultas() {
            try {
                // Construir parâmetros da query
                const params = new URLSearchParams({
                    limit: itemsPerPage.toString(),
                    offset: ((currentPage - 1) * itemsPerPage).toString()
                });
                
                // Adicionar filtros se existirem
                if (currentFilters.search) params.append('search', currentFilters.search);
                if (currentFilters.status) params.append('status', currentFilters.status);
                if (currentFilters.tem_tvi) params.append('tem_tvi', currentFilters.tem_tvi);
                if (currentFilters.tem_divida) params.append('tem_divida', currentFilters.tem_divida);
                
                const response = await fetch(`/api/consultas?${params}`);
                const consultas = await response.json();
                consultasData = consultas; // Armazenar para uso no modal
                
                // Buscar total de itens
                const countParams = new URLSearchParams();
                if (currentFilters.search) countParams.append('search', currentFilters.search);
                if (currentFilters.status) countParams.append('status', currentFilters.status);
                if (currentFilters.tem_tvi) countParams.append('tem_tvi', currentFilters.tem_tvi);
                if (currentFilters.tem_divida) countParams.append('tem_divida', currentFilters.tem_divida);
                
                const countResponse = await fetch(`/api/consultas/count?${countParams}`);
                const countData = await countResponse.json();
                totalItems = countData.total;
                
                updateTable(consultas);
                updatePagination();
                
            } catch (error) {
                console.error('Erro ao buscar consultas:', error);
            }
        }
        
        function updateTable(consultas) {
            const tbody = document.getElementById('resultTable');
            const emptyState = document.getElementById('emptyState');
            const totalResults = document.getElementById('totalResults');
            
            totalResults.textContent = `${totalItems} resultado${totalItems !== 1 ? 's' : ''}`;
            
            if (consultas.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            tbody.innerHTML = consultas.map(consulta => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${consulta.nome_empresa || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${consulta.inscricao_estadual || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(consulta.status_ie)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getTVIBadge(consulta.tem_tvi)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getDividasBadge(consulta.tem_divida_pendente)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${consulta.valor_debitos ? 
                                new Intl.NumberFormat('pt-BR', { 
                                    style: 'currency', 
                                    currency: 'BRL' 
                                }).format(consulta.valor_debitos) : 
                                'R$ 0,00'
                            }
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">
                            ${new Date(consulta.data_consulta).toLocaleDateString('pt-BR')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="showDetails(${consulta.id})" class="text-blue-600 hover:text-blue-900">
                                <i data-lucide="eye" class="h-4 w-4"></i>
                            </button>
                            <button onclick="deleteConsulta(${consulta.id})" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Re-inicializar ícones
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao criar ícones:', error);
            }
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const showingFrom = totalItems === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
            const showingTo = Math.min(currentPage * itemsPerPage, totalItems);
            
            const showingFromEl = document.getElementById('showingFrom');
            const showingToEl = document.getElementById('showingTo');
            const showingTotalEl = document.getElementById('showingTotal');
            const pageInfoEl = document.getElementById('pageInfo');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            
            if (showingFromEl) showingFromEl.textContent = showingFrom;
            if (showingToEl) showingToEl.textContent = showingTo;
            if (showingTotalEl) showingTotalEl.textContent = totalItems;
            if (pageInfoEl) pageInfoEl.textContent = `Página ${currentPage} de ${totalPages}`;
            
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }
        
        async function deleteConsulta(consultaId) {
            if (!confirm('Tem certeza que deseja excluir esta consulta?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/consultas/${consultaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Recarregar dados
                    await fetchConsultas();
                    await fetchEstatatisticas();
                    
                    // Mostrar mensagem de sucesso
                    showNotification('Consulta excluída com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Erro ao excluir: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir consulta:', error);
                showNotification('Erro ao excluir consulta', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function applyFilters() {
            const searchEl = document.getElementById('searchFilter');
            const statusEl = document.getElementById('statusFilter');
            const tviEl = document.getElementById('tviFilter');
            const dividaEl = document.getElementById('dividaFilter');
            const clearBtnEl = document.getElementById('clearFiltersBtn');
            
            currentFilters = {
                search: searchEl ? searchEl.value.trim() : '',
                status: statusEl ? statusEl.value : '',
                tem_tvi: tviEl ? tviEl.value : '',
                tem_divida: dividaEl ? dividaEl.value : ''
            };
            
            currentPage = 1; // Resetar para primeira página
            fetchConsultas();
            
            // Mostrar/esconder botão de limpar filtros
            const hasFilters = Object.values(currentFilters).some(value => value !== '');
            if (clearBtnEl) {
                clearBtnEl.classList.toggle('hidden', !hasFilters);
            }
        }
        
        function clearFilters() {
            const searchEl = document.getElementById('searchFilter');
            const statusEl = document.getElementById('statusFilter');
            const tviEl = document.getElementById('tviFilter');
            const dividaEl = document.getElementById('dividaFilter');
            const clearBtnEl = document.getElementById('clearFiltersBtn');
            
            if (searchEl) searchEl.value = '';
            if (statusEl) statusEl.value = '';
            if (tviEl) tviEl.value = '';
            if (dividaEl) dividaEl.value = '';
            
            currentFilters = { search: '', status: '', tem_tvi: '', tem_divida: '' };
            currentPage = 1;
            
            fetchConsultas();
            if (clearBtnEl) {
                clearBtnEl.classList.add('hidden');
            }
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const statusSection = document.getElementById('statusSection');
                const statusText = document.getElementById('statusText');
                const progressFill = document.getElementById('progressFill');
                const currentStep = document.getElementById('currentStep');
                const submitBtn = document.getElementById('submitBtn');
                
                if (data.data.running) {
                    statusSection.classList.remove('hidden');
                    statusText.textContent = 'Executando...';
                    progressFill.style.width = `${data.data.progress}%`;
                    currentStep.textContent = data.data.current_step;
                    submitBtn.disabled = true;
                    
                    if (!isPolling) {
                        startPolling();
                    }
                } else {
                    if (isPolling) {
                        stopPolling();
                        // Atualizar dados após conclusão
                        await fetchConsultas();
                        await fetchEstatatisticas();
                    }
                    
                    statusText.textContent = data.message;
                    submitBtn.disabled = false;
                    
                    if (data.data.progress === 100) {
                        setTimeout(() => {
                            statusSection.classList.add('hidden');
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar status:', error);
            }
        }

        function startPolling() {
            isPolling = true;
            pollInterval = setInterval(fetchStatus, 2000);
        }

        function stopPolling() {
            isPolling = false;
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Utility functions
        function getStatusBadge(status) {
            if (!status) return '<span class="badge-info">N/A</span>';
            
            if (status === 'ATIVO') {
                return '<span class="badge-success">Ativo</span>';
            } else if (status === 'INATIVO') {
                return '<span class="badge-danger">Inativo</span>';
            } else {
                return `<span class="badge-warning">${status}</span>`;
            }
        }

        function getTVIBadge(tem_tvi) {
            if (!tem_tvi) return '<span class="badge-info">N/A</span>';
            
            if (tem_tvi === 'SIM') {
                return '<span class="badge-warning">Sim</span>';
            } else if (tem_tvi === 'NÃO') {
                return '<span class="badge-success">Não</span>';
            } else {
                return `<span class="badge-info">${tem_tvi}</span>`;
            }
        }

        function getDividasBadge(tem_divida) {
            if (!tem_divida) return '<span class="badge-info">N/A</span>';
            
            if (tem_divida === 'SIM') {
                return '<span class="badge-danger">Sim</span>';
            } else if (tem_divida === 'NÃO') {
                return '<span class="badge-success">Não</span>';
            } else {
                return `<span class="badge-info">${tem_divida}</span>`;
            }
        }

        // Event Listeners
        document.getElementById('consultaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                usuario: formData.get('usuario') || null,
                senha: formData.get('senha') || null,
                inscricao_estadual: formData.get('inscricaoEstadual') || null
            };
            
            try {
                const response = await fetch('/api/consulta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    document.getElementById('statusSection').classList.remove('hidden');
                    startPolling();
                } else {
                    const error = await response.json();
                    alert(`Erro: ${error.detail}`);
                }
            } catch (error) {
                console.error('Erro ao executar consulta:', error);
                alert('Erro ao executar consulta');
            }
        });

        // Função para executar consultas das empresas selecionadas
        async function executeSelectedEmpresas() {
            const checkboxes = document.querySelectorAll('#empresasTable input[type="checkbox"]:checked');
            const selectedEmpresaIds = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.value !== 'all') {
                    selectedEmpresaIds.push(parseInt(checkbox.value));
                }
            });
            
            if (selectedEmpresaIds.length === 0) {
                alert('Selecione pelo menos uma empresa para executar as consultas.');
                return;
            }
            
            console.log('IDs das empresas selecionadas:', selectedEmpresaIds);
            
            try {
                const executeBtn = document.getElementById('executeSelectedBtn');
                executeBtn.disabled = true;
                executeBtn.innerHTML = '<i data-lucide="loader" class="h-4 w-4 mr-2 animate-spin"></i>Adicionando à fila...';
                
                const response = await fetch('/api/fila/adicionar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        empresa_ids: selectedEmpresaIds,
                        prioridade: 0
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Empresas adicionadas à fila:', result);
                    
                    alert(`${result.message}. O processamento começará automaticamente.`);
                    
                    // Limpar seleções
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    updateSelectedEmpresas();
                    
                    // Atualizar aba de fila se estiver aberta
                    if (currentTab === 'fila') {
                        await fetchFilaJobs();
                    }
                    
                } else {
                    const error = await response.json();
                    alert(`Erro ao adicionar à fila: ${error.detail}`);
                }
                
            } catch (error) {
                console.error('Erro ao adicionar empresas à fila:', error);
                alert('Erro ao adicionar empresas à fila de processamento.');
            } finally {
                const executeBtn = document.getElementById('executeSelectedBtn');
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i data-lucide="play" class="h-4 w-4 mr-2"></i>Executar Consultas';
                lucide.createIcons();
            }
        }

        // Funções da Fila de Processamento
        async function fetchFilaStats() {
            try {
                const response = await fetch('/api/fila/stats');
                const stats = await response.json();
                
                document.getElementById('filaTotal').textContent = stats.total;
                document.getElementById('filaPending').textContent = stats.pending;
                document.getElementById('filaRunning').textContent = stats.running;
                document.getElementById('filaCompleted').textContent = stats.completed;
                document.getElementById('filaFailed').textContent = stats.failed;
                
            } catch (error) {
                console.error('Erro ao buscar estatísticas da fila:', error);
            }
        }

        async function fetchFilaJobs() {
            try {
                const response = await fetch('/api/fila?limit=50&offset=0');
                const jobs = await response.json();
                
                updateFilaTable(jobs);
                await fetchFilaStats();
                
            } catch (error) {
                console.error('Erro ao buscar jobs da fila:', error);
            }
        }

        function updateFilaTable(jobs) {
            const tbody = document.getElementById('filaJobsTable');
            const emptyState = document.getElementById('filaEmptyState');
            
            if (!jobs || jobs.length === 0) {
                if (tbody) tbody.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }
            
            if (emptyState) emptyState.classList.add('hidden');
            
            if (tbody) {
                tbody.innerHTML = jobs.map(job => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${job.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${job.empresa_nome || `ID: ${job.empresa_id}`}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${getJobStatusBadge(job.status)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDateTime(job.data_criacao)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${job.data_inicio ? formatDateTime(job.data_inicio) : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${job.data_conclusao ? formatDateTime(job.data_conclusao) : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${job.tentativas}/${job.max_tentativas}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Re-inicializar ícones
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao inicializar ícones:', error);
            }
        }

        function getJobStatusBadge(status) {
            switch (status) {
                case 'pending':
                    return '<span class="badge-warning">Pendente</span>';
                case 'running':
                    return '<span class="badge-info">Executando</span>';
                case 'completed':
                    return '<span class="badge-success">Concluído</span>';
                case 'failed':
                    return '<span class="badge-danger">Falhou</span>';
                default:
                    return `<span class="badge-info">${status}</span>`;
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR');
            } catch (error) {
                return dateString;
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            await fetchConsultas();
            await fetchEstatatisticas();
            await fetchStatus();
        });

        // Event listeners para abas
        document.getElementById('tab-consultas').addEventListener('click', () => switchTab('consultas'));
        document.getElementById('tab-empresas').addEventListener('click', () => switchTab('empresas'));
        document.getElementById('tab-fila').addEventListener('click', () => switchTab('fila'));

        // Event listeners para empresas
        const addEmpresaBtn = document.getElementById('addEmpresaBtn');
        if (addEmpresaBtn) {
            addEmpresaBtn.addEventListener('click', () => openEmpresaModal());
        }

        const executeSelectedBtn = document.getElementById('executeSelectedBtn');
        if (executeSelectedBtn) {
            executeSelectedBtn.addEventListener('click', () => executeSelectedEmpresas());
        }

        // Event listeners para fila
        const refreshFilaBtn = document.getElementById('refreshFilaBtn');
        if (refreshFilaBtn) {
            refreshFilaBtn.addEventListener('click', () => fetchFilaJobs());
        }

        // Filtros para empresas
        const empresaSearchFilter = document.getElementById('empresaSearchFilter');
        if (empresaSearchFilter) {
            empresaSearchFilter.addEventListener('input', function() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    applyEmpresasFilters();
                }, 500);
            });
        }

        const empresaAtivoFilter = document.getElementById('empresaAtivoFilter');
        if (empresaAtivoFilter) {
            empresaAtivoFilter.addEventListener('change', applyEmpresasFilters);
        }

        // Paginação para empresas
        const empresasPrevPageBtn = document.getElementById('empresasPrevPageBtn');
        if (empresasPrevPageBtn) {
            empresasPrevPageBtn.addEventListener('click', function() {
                if (currentEmpresasPage > 1) {
                    currentEmpresasPage--;
                    fetchEmpresas();
                }
            });
        }

        const empresasNextPageBtn = document.getElementById('empresasNextPageBtn');
        if (empresasNextPageBtn) {
            empresasNextPageBtn.addEventListener('click', function() {
                const totalPages = Math.ceil(totalEmpresasItems / empresasItemsPerPage);
                if (currentEmpresasPage < totalPages) {
                    currentEmpresasPage++;
                    fetchEmpresas();
                }
            });
        }

        // Event listener para formulário de empresa
        const empresaForm = document.getElementById('empresaForm');
        if (empresaForm) {
            empresaForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const empresaId = document.getElementById('empresaId').value;
                const isEditing = !!empresaId;
                
                const empresaData = {
                    nome_empresa: document.getElementById('empresaNome').value,
                    cnpj: document.getElementById('empresaCnpj').value,
                    inscricao_estadual: document.getElementById('empresaIE').value,
                    cpf_socio: document.getElementById('empresaCpf').value,
                    observacoes: document.getElementById('empresaObservacoes').value,
                    ativo: document.getElementById('empresaAtivo').checked
                };
                
                // Incluir senha apenas se fornecida
                const senhaField = document.getElementById('empresaSenha');
                if (senhaField.value.trim()) {
                    empresaData.senha = senhaField.value;
                }
                
                try {
                    const url = isEditing ? `/api/empresas/${empresaId}` : '/api/empresas';
                    const method = isEditing ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(empresaData)
                    });
                    
                    if (response.ok) {
                        closeEmpresaModal();
                        await fetchEmpresas();
                        showNotification(
                            isEditing ? 'Empresa atualizada com sucesso!' : 'Empresa criada com sucesso!', 
                            'success'
                        );
                    } else {
                        const error = await response.json();
                        showNotification(`Erro: ${error.detail}`, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao salvar empresa:', error);
                    showNotification('Erro ao salvar empresa', 'error');
                }
            });
        }

        // Máscaras de entrada para campos
        function addInputMasks() {
            const cnpjField = document.getElementById('empresaCnpj');
            const cpfField = document.getElementById('empresaCpf');
            
            if (cnpjField) {
                cnpjField.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 14) {
                        value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                        e.target.value = value;
                    }
                });
            }
            
            if (cpfField) {
                cpfField.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                        e.target.value = value;
                    }
                });
            }
        }

        // Event listeners para filtros
        const searchFilter = document.getElementById('searchFilter');
        const statusFilter = document.getElementById('statusFilter');
        const tviFilter = document.getElementById('tviFilter');
        const dividaFilter = document.getElementById('dividaFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        
        if (searchFilter) {
            searchFilter.addEventListener('input', function() {
                // Aplicar filtro após pequeno delay para evitar muitas chamadas
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 500);
            });
        }
        
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        if (tviFilter) tviFilter.addEventListener('change', applyFilters);
        if (dividaFilter) dividaFilter.addEventListener('change', applyFilters);
        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearFilters);
        
        // Event listeners para paginação
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        
        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    fetchConsultas();
                }
            });
        }
        
        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', function() {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchConsultas();
                }
            });
        }

        // Funções do Modal
        function showDetails(consultaId) {
            const consulta = consultasData.find(c => c.id === consultaId);
            if (!consulta) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                        <p class="mt-1 text-sm text-gray-900">${consulta.nome_empresa || 'N/A'}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Inscrição Estadual</label>
                            <p class="mt-1 text-sm text-gray-900">${consulta.inscricao_estadual || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CNPJ</label>
                            <p class="mt-1 text-sm text-gray-900">${consulta.cnpj || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status Cadastral</label>
                        <div class="mt-1">${getStatusBadge(consulta.status_ie)}</div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">TVIs</label>
                            <div class="mt-1">${getTVIBadge(consulta.tem_tvi)}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dívida Pendente</label>
                            <div class="mt-1">${getDividasBadge(consulta.tem_divida_pendente)}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Omisso Declaração</label>
                            <div class="mt-1">${getDividasBadge(consulta.omisso_declaracao)}</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Valor das Dívidas</label>
                        <p class="mt-1 text-lg font-semibold text-gray-900">
                            ${consulta.valor_debitos ? 
                                new Intl.NumberFormat('pt-BR', { 
                                    style: 'currency', 
                                    currency: 'BRL' 
                                }).format(consulta.valor_debitos) : 
                                'R$ 0,00'
                            }
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Inscrito em Cadastro Restritivo</label>
                        <div class="mt-1">${getDividasBadge(consulta.inscrito_restritivo)}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data da Consulta</label>
                        <p class="mt-1 text-sm text-gray-900">
                            ${new Date(consulta.data_consulta).toLocaleString('pt-BR')}
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('detailsModal').classList.remove('hidden');
            // Re-inicializar ícones no modal
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao criar ícones no modal:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // Fechar modal ao clicar fora
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Inicialização
        async function init() {
            await fetchEstatatisticas();
            await fetchConsultas();
            await fetchStatus();
            
            // Também carregar empresas para que estejam prontas quando a aba for aberta
            try {
                await fetchEmpresas();
                console.log('Empresas carregadas na inicialização');
            } catch (error) {
                console.warn('Erro ao carregar empresas na inicialização:', error);
            }
            
            // Inicializar ícones Lucide depois que os elementos estão carregados
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Erro ao inicializar ícones Lucide:', error);
            }
        }

        // Carregar dados iniciais quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                init();
                addInputMasks();
            });
        } else {
            init();
            addInputMasks();
        }
    </script>
</body>
</html>